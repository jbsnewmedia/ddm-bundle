{% set datatable_title = options.title|default('datatable.title'|vistrans) %}
{% set datatable_options = {
    apiUrl: '',
    perPage: 10,
    search: "",
    sorting: {}
}|merge(options.datatable_options|default({})) %}

{% set datatable_language = {
    showLabel: 'datatable.showLabel'|vistrans,
    entriesLabel: 'datatable.entriesLabel'|vistrans,
    searchLabel: 'datatable.searchLabel'|vistrans,
    previousLabel: 'datatable.previousLabel'|vistrans,
    nextLabel: 'datatable.nextLabel'|vistrans,
    showingEntries: 'datatable.showingEntries'|vistrans,
    showingFilteredEntries: 'datatable.showingFilteredEntries'|vistrans,
    modalCancelLabel: 'datatable.modalCancelLabel'|vistrans,
    modalSaveLabel: 'datatable.modalSaveLabel'|vistrans,
    modalEditLabel: 'datatable.modalEditLabel'|vistrans,
    modalDeleteLabel: 'datatable.modalDeleteLabel'|vistrans,
    modalAddTitle: 'datatable.modalAddTitle'|vistrans,
    modalEditTitle: 'datatable.modalEditTitle'|vistrans,
    modalDeleteTitle: 'datatable.modalDeleteTitle'|vistrans,
    modalDeleteContent: 'datatable.modalDeleteContent'|vistrans
}|merge(options.datatable_language|default({})) %}
<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>{{ datatable_title }}</div>
        {% if options.add_url|default(false) %}
            <button class="btn btn-sm btn-success btn-add-new-user" data-url="{{ options.add_url }}">
                <i class="fas fa-plus"></i> {{ options.add_label|default('Hinzufügen') }}
            </button>
        {% endif %}
    </div>
    <div class="card-body">
        <div id="avalynx-datatable"
             data-options="{{ datatable_options|json_encode|e('html_attr') }}"
             data-language="{{ datatable_language|json_encode|e('html_attr') }}"
        ></div>
    </div>
</div>

<div id="edit-modal"></div>
<div id="add-modal"></div>
<div id="delete-modal"></div>

<style>
    .avalynx-modal .modal-body {
        padding: 0 !important;
    }
    #modal-iframe, .modal-body-content {
        width: 100%;
        min-height: 400px;
        height: 100%;
        border: none;
        display: block;
        overflow: hidden;
    }
    .modal-body-content {
        padding: 1rem;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const datatableElement = document.getElementById("avalynx-datatable");
        if (!datatableElement) return;

        const options = JSON.parse(datatableElement.dataset.options);
        const languageSource = JSON.parse(datatableElement.dataset.language);

        const language = {
            ...languageSource,
            showingEntries: (start, end, total) => languageSource.showingEntries.replace('{start}', start).replace('{end}', end).replace('{total}', total),
            showingFilteredEntries: (start, end, filtered, total) => languageSource.showingFilteredEntries.replace('{start}', start).replace('{end}', end).replace('{filtered}', filtered).replace('{total}', total)
        };

        new AvalynxDataTable("avalynx-datatable", options, language);

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'form-success') {
                // Close all modals
                const editModal = AvalynxModal.getInstance("edit-modal");
                if (editModal) editModal.close();
                const addModal = AvalynxModal.getInstance("add-modal");
                if (addModal) addModal.close();

                // Refresh datatable
                const datatable = AvalynxDataTable.getInstance("avalynx-datatable");
                if (datatable) {
                    datatable.fetchData();
                }
            }
            if (event.data && event.data.type === 'form-error') {
                const saveBtn = document.querySelector('.avalynx-modal .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                }
            }
        });

        document.addEventListener('click', function(e) {
            const btnAddNew = e.target.closest('.btn-add-new-user');
            if (btnAddNew) {
                const formUrl = btnAddNew.dataset.url;

                const modal = new AvalynxModal("add-modal", {
                    title: languageSource.modalAddTitle,
                    body: '<iframe id="modal-iframe" src="' + formUrl + '"></iframe>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalSaveLabel,
                            class: 'btn btn-primary',
                            onClick: function() {
                                const iframe = document.getElementById('modal-iframe');
                                if (iframe && iframe.contentWindow) {
                                    this.disabled = true;
                                    iframe.contentWindow.postMessage('submit-form', '*');
                                }
                            }
                        }
                    ]
                });
                modal.open();
            }

            const btnEdit = e.target.closest('.btn-edit-user');
            if (btnEdit) {
                const userId = btnEdit.dataset.id;
                const formUrl = btnEdit.dataset.url;

                const modal = new AvalynxModal("edit-modal", {
                    title: languageSource.modalEditTitle,
                    body: '<iframe id="modal-iframe" src="' + formUrl + '"></iframe>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalEditLabel,
                            class: 'btn btn-primary',
                            onClick: function() {
                                const iframe = document.getElementById('modal-iframe');
                                if (iframe && iframe.contentWindow) {
                                    this.disabled = true;
                                    iframe.contentWindow.postMessage('submit-form', '*');
                                }
                            }
                        }
                    ]
                });
                modal.open();
            }

            const btnDelete = e.target.closest('.btn-delete-user');
            if (btnDelete) {
                const userId = btnDelete.dataset.id;
                const deleteUrl = btnDelete.dataset.url;

                const modal = new AvalynxModal("delete-modal", {
                    title: languageSource.modalDeleteTitle,
                    body: '<div class="modal-body-content">' + languageSource.modalDeleteContent.replace('{id}', userId) + '</div>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalDeleteLabel,
                            class: 'btn btn-danger',
                            onClick: function() {
                                if (deleteUrl) {
                                    fetch(deleteUrl, { method: 'DELETE' })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                // Refresh datatable
                                                const datatable = AvalynxDataTable.getInstance("avalynx-datatable");
                                                if (datatable) {
                                                    datatable.fetchData();
                                                }
                                                modal.close();
                                            } else {
                                                alert('Fehler beim Löschen: ' + (data.message || 'Unbekannter Fehler'));
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            alert('Fehler beim Löschen');
                                        });
                                } else {
                                    console.log('User ' + userId + ' gelöscht (Simulation)');
                                    modal.close();
                                }
                            }
                        }
                    ]
                });
                modal.open();
            }
        });
    });
</script>
