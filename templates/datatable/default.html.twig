{% set datatable_title = options.title|default('ddm.title'|vistrans([], 'datatable')) %}
{% set datatable_options = {
    apiUrl: '',
    perPage: 10,
    search: "",
    sorting: {}
}|merge(options.datatable_options|default({})) %}

{% set datatable_language = {
    showLabel: 'ddm.showLabel'|vistrans([], 'datatable'),
    entriesLabel: 'ddm.entriesLabel'|vistrans([], 'datatable'),
    searchLabel: 'ddm.searchLabel'|vistrans([], 'datatable'),
    previousLabel: 'ddm.previousLabel'|vistrans([], 'datatable'),
    nextLabel: 'ddm.nextLabel'|vistrans([], 'datatable'),
    showingEntries: 'ddm.showingEntries'|vistrans([], 'datatable'),
    showingFilteredEntries: 'ddm.showingFilteredEntries'|vistrans([], 'datatable'),
    modalCancelLabel: 'ddm.modalCancelLabel'|vistrans([], 'datatable'),
    modalSaveLabel: 'ddm.modalSaveLabel'|vistrans([], 'datatable'),
    modalEditLabel: 'ddm.modalEditLabel'|vistrans([], 'datatable'),
    modalDeleteLabel: 'ddm.modalDeleteLabel'|vistrans([], 'datatable'),
    modalAddTitle: 'ddm.modalAddTitle'|vistrans([], 'datatable'),
    modalEditTitle: 'ddm.modalEditTitle'|vistrans([], 'datatable'),
    modalDeleteTitle: 'ddm.modalDeleteTitle'|vistrans([], 'datatable'),
    modalDeleteContent: 'ddm.modalDeleteContent'|vistrans([], 'datatable'),
    modalSearchTitle: 'ddm.modalSearchTitle'|vistrans([], 'datatable'),
    modalSearchLabel: 'ddm.modalSearchLabel'|vistrans([], 'datatable'),
    modalSearchChangeLabel: 'ddm.modalSearchChangeLabel'|vistrans([], 'datatable'),
    modalSearchResetLabel: 'ddm.modalSearchResetLabel'|vistrans([], 'datatable'),
    errorDelete: 'ddm.errorDelete'|vistrans([], 'datatable'),
    errorDeleteUnknown: 'ddm.errorDeleteUnknown'|vistrans([], 'datatable'),
    confirmDeleteSimulation: 'ddm.confirmDeleteSimulation'|vistrans([], 'datatable')
}|merge(options.datatable_language|default({})) %}
<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>{{ datatable_title }}</div>
        <div class="d-flex gap-2">
            {% if options.add_url|default(false) %}
                <button class="btn btn-sm btn-success btn-add-new-user" data-url="{{ options.add_url }}">
                    <i class="fas fa-plus"></i> {{ options.add_label|default('ddm.modalAddTitle'|vistrans([], 'datatable')) }}
                </button>
            {% endif %}
            {% if options.search_url|default(false) %}
                <button class="btn btn-sm btn-primary btn-extend-search" data-url="{{ options.search_url }}">
                    <i class="fas fa-search"></i> <span class="btn-extend-search-label">{{ options.search_label|default('ddm.modalSearchTitle'|vistrans([], 'datatable')) }}</span>
                </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div id="avalynx-datatable"
             data-options="{{ datatable_options|json_encode|e('html_attr') }}"
             data-language="{{ datatable_language|json_encode|e('html_attr') }}"
        ></div>
    </div>
</div>

<div id="edit-modal"></div>
<div id="add-modal"></div>
<div id="delete-modal"></div>
<div id="search-modal"></div>

<style>
    .avalynx-modal .modal-body {
        padding: 0 !important;
    }
    #modal-iframe, .modal-body-content {
        width: 100%;
        min-height: 400px;
        height: 100%;
        border: none;
        display: block;
        overflow: hidden;
    }
    .modal-body-content {
        padding: 1rem;
    }
    .btn-extend-search.active {
        background-color: var(--bs-warning);
        border-color: var(--bs-warning);
        color: #000;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const datatableElement = document.getElementById("avalynx-datatable");
        if (!datatableElement) return;

        const options = JSON.parse(datatableElement.dataset.options);
        const languageSource = JSON.parse(datatableElement.dataset.language);

        // Ensure search_fields are in apiParams for the initial fetchData call (inside constructor)
        if (options.search_fields) {
            options.apiParams = options.apiParams || {};
            for (const [key, value] of Object.entries(options.search_fields)) {
                options.apiParams['search_fields[' + key + ']'] = value;
            }
        }

        const language = {
            ...languageSource,
            showingEntries: (start, end, total) => languageSource.showingEntries.replace('{start}', start).replace('{end}', end).replace('{total}', total),
            showingFilteredEntries: (start, end, filtered, total) => languageSource.showingFilteredEntries.replace('{start}', start).replace('{end}', end).replace('{filtered}', filtered).replace('{total}', total)
        };

        if (options.renderSearch === false) {
            options.renderSearch = false;
        }

        const datatable = new AvalynxDataTable("avalynx-datatable", options, language);
        window.avalynxDataTableInstance = datatable;

        const originalFetchData = datatable.fetchData.bind(datatable);
        datatable.fetchData = function() {
            this.options.apiParams = this.options.apiParams || {};
            // Clean up old search fields from apiParams
            for (const key in this.options.apiParams) {
                if (key.startsWith('search_fields[')) {
                    delete this.options.apiParams[key];
                }
            }
            // Add current search fields
            if (this.options.search_fields) {
                for (const [key, value] of Object.entries(this.options.search_fields)) {
                    this.options.apiParams['search_fields[' + key + ']'] = value;
                }
            }
            return originalFetchData();
        };

        const updateSearchButtonLabel = () => {
            const searchFields = datatable.options.search_fields || {};
            const btnLabel = document.querySelector('.btn-extend-search-label');
            const btn = document.querySelector('.btn-extend-search');
            if (btnLabel) {
                if (Object.keys(searchFields).length > 0) {
                    btnLabel.innerText = languageSource.modalSearchChangeLabel;
                    if (btn) btn.classList.add('active');
                } else {
                    btnLabel.innerText = languageSource.modalSearchLabel || languageSource.modalSearchTitle;
                    if (btn) btn.classList.remove('active');
                }
            }
        };
        updateSearchButtonLabel();

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'form-success') {
                try {
                    const msg = (event.data.response && event.data.response.message) ? event.data.response.message : '';
                    if (msg) {
                        const alertOptions = { duration: 5000, position: 'bottom-right' };
                        new AvalynxAlert(msg, 'success', alertOptions);
                    }
                } catch (e) {
                    console.error('DDM: Error showing AvalynxAlert', e);
                }

                if (window.editModalInstance) {
                    window.editModalInstance.close();
                } else {
                    const editModal = AvalynxModal.getInstance ? AvalynxModal.getInstance("edit-modal") : null;
                    if (editModal) editModal.close();
                }
                if (window.addModalInstance) {
                    window.addModalInstance.close();
                } else {
                    const addModal = AvalynxModal.getInstance ? AvalynxModal.getInstance("add-modal") : null;
                    if (addModal) addModal.close();
                }
                if (window.searchModalInstance) {
                    window.searchModalInstance.close();

                    const searchFields = event.data.response.search_fields || {};
                    const datatable = window.avalynxDataTableInstance;
                    if (datatable) {
                        datatable.options.search_fields = searchFields;
                        updateSearchButtonLabel();
                    }
                }

                const datatable = window.avalynxDataTableInstance;
                if (datatable) {
                    datatable.fetchData();
                }
            }
            if (event.data && event.data.type === 'form-error') {
                const saveBtn = document.querySelector('.avalynx-modal .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                }
            }
        });

        document.addEventListener('click', function(e) {
            const btnAddNew = e.target.closest('.btn-add-new-user');
            if (btnAddNew) {
                const formUrl = btnAddNew.dataset.url;

                const modal = new AvalynxModal("add-modal", {
                    title: languageSource.modalAddTitle,
                    body: '<iframe id="modal-iframe" src="' + formUrl + '"></iframe>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalSaveLabel,
                            class: 'btn btn-primary',
                            onClick: function() {
                                const iframe = document.getElementById('modal-iframe');
                                if (iframe && iframe.contentWindow) {
                                    this.disabled = true;
                                    iframe.contentWindow.postMessage('submit-form', '*');
                                }
                            }
                        }
                    ]
                });
                window.addModalInstance = modal;
                modal.open();
            }

            const btnExtendSearch = e.target.closest('.btn-extend-search');
            if (btnExtendSearch) {
                const searchUrl = btnExtendSearch.dataset.url;
                const searchFields = datatable.options.search_fields || {};
                const hasActiveSearch = Object.keys(searchFields).length > 0;

                const buttons = [
                    {
                        label: languageSource.modalCancelLabel,
                        class: 'btn btn-secondary',
                        onClick: function() {
                            modal.close();
                        }
                    }
                ];

                if (hasActiveSearch) {
                    buttons.push({
                        label: languageSource.modalSearchResetLabel,
                        class: 'btn btn-warning',
                        onClick: function() {
                            const iframe = document.getElementById('modal-iframe');
                            if (iframe && iframe.contentWindow) {
                                this.disabled = true;
                                iframe.contentWindow.postMessage({ type: 'reset-search' }, '*');
                            }
                        }
                    });
                }

                buttons.push({
                    label: languageSource.modalSearchLabel || languageSource.modalSearchTitle,
                    class: 'btn btn-primary',
                    onClick: function() {
                        const iframe = document.getElementById('modal-iframe');
                        if (iframe && iframe.contentWindow) {
                            this.disabled = true;
                            iframe.contentWindow.postMessage('submit-form', '*');
                        }
                    }
                });

                const modal = new AvalynxModal("search-modal", {
                    title: languageSource.modalSearchTitle,
                    body: '<iframe id="modal-iframe" src="' + searchUrl + '"></iframe>',
                    bodyIsHtml: true,
                    buttons: buttons
                });
                window.searchModalInstance = modal;
                modal.open();
            }

            const btnEdit = e.target.closest('.btn-edit-user');
            if (btnEdit) {
                const userId = btnEdit.dataset.id;
                const formUrl = btnEdit.dataset.url;

                const modal = new AvalynxModal("edit-modal", {
                    title: languageSource.modalEditTitle,
                    body: '<iframe id="modal-iframe" src="' + formUrl + '"></iframe>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalEditLabel,
                            class: 'btn btn-primary',
                            onClick: function() {
                                const iframe = document.getElementById('modal-iframe');
                                if (iframe && iframe.contentWindow) {
                                    this.disabled = true;
                                    iframe.contentWindow.postMessage('submit-form', '*');
                                }
                            }
                        }
                    ]
                });
                window.editModalInstance = modal;
                modal.open();
            }

            const btnDelete = e.target.closest('.btn-delete-user');
            if (btnDelete) {
                const userId = btnDelete.dataset.id;
                const deleteUrl = btnDelete.dataset.url;

                const modal = new AvalynxModal("delete-modal", {
                    title: languageSource.modalDeleteTitle,
                    body: '<div class="modal-body-content">' + languageSource.modalDeleteContent.replace('{id}', userId) + '</div>',
                    bodyIsHtml: true,
                    buttons: [
                        {
                            label: languageSource.modalCancelLabel,
                            class: 'btn btn-secondary',
                            onClick: function() {
                                modal.close();
                            }
                        },
                        {
                            label: languageSource.modalDeleteLabel,
                            class: 'btn btn-danger',
                            onClick: function() {
                                if (deleteUrl) {
                                    fetch(deleteUrl, { method: 'DELETE' })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                const datatable = window.avalynxDataTableInstance;
                                                if (datatable) {
                                                    datatable.fetchData();
                                                }
                                                modal.close();
                                            } else {
                                                alert(languageSource.errorDelete.replace('{error}', (data.message || languageSource.errorDeleteUnknown)));
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            alert(languageSource.errorDelete.replace('{error}', languageSource.errorDeleteUnknown));
                                        });
                                } else {
                                    console.log(languageSource.confirmDeleteSimulation.replace('{id}', userId));
                                    modal.close();
                                }
                            }
                        }
                    ]
                });
                modal.open();
            }
        });
    });
</script>
