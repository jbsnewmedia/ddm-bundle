<form id="form_validation" action="{{ options.action|default('') }}" method="POST" class="p-3">
    {% for field in fields %}
        {{ include(field.template, {field: field, options: options}) }}
    {% endfor %}

    <button type="submit" class="btn btn-primary d-none" id="submit-btn-hidden">{{ options.submitLabel|default('ddm.modalSaveLabel'|vistrans([], 'datatable')) }}</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = new AvalynxForm('form_validation', {
            onSuccess: (response) => {
                if (window.parent) {
                    window.parent.postMessage({ type: 'form-success', response: response }, '*');
                }
            },
            onError: (response) => {
                if (window.parent) {
                    window.parent.postMessage({ type: 'form-error', response: response }, '*');
                }
            }
        });

        window.addEventListener('message', function(event) {
            if (event.data === 'submit-form') {
                document.getElementById('form_validation').dispatchEvent(new Event('submit', { cancelable: true }));
            }
            if (event.data && event.data.type === 'reset-search') {
                const form = document.getElementById('form_validation');
                const resetInput = document.createElement('input');
                resetInput.type = 'hidden';
                resetInput.name = '_reset';
                resetInput.value = '1';
                form.appendChild(resetInput);
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });
    });
</script>
