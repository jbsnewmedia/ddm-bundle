{% extends '@Vis/base.html.twig' %}

{% block javascripts %}
    {{ include('@DDM/form/header.html.twig', {
        asset: [
            'twbs/bootstrap/dist/js/bootstrap.bundle.min.js',
            'avalynx/avalynx-form/dist/js/avalynx-form.js',
            'avalynx/avalynx-select/dist/js/avalynx-select.js'
        ]}) }}

    {{ parent() }}
{% endblock %}

{% block stylesheets %}
    {{ include('@DDM/form/header.html.twig', {
        asset: [
            'twbs/bootstrap/dist/css/bootstrap.min.css'
        ]}) }}

    {{ parent() }}
{% endblock %}

{% block body %}
    {{ parent() }}

    <form id="form_validation" action="{{ options.action|default('') }}" method="POST" class="p-3">
        {% for field in fields %}
            {# We force search names to be search_fields[identifier] and disable required #}
            {% set field_identifier = field.getIdentifier() %}
            {{ include(field.template, {
                field: field,
                options: options|merge({'override_identifier': 'search_fields[' ~ field_identifier ~ ']', 'override_id': 'search_' ~ field_identifier}),
                required: false
            }) }}
        {% endfor %}

        <button type="submit" class="btn btn-primary d-none" id="submit-btn-hidden">{{ options.submitLabel|default('ddm.modalSearchLabel'|vistrans([], 'datatable')) }}</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = new AvalynxForm('form_validation', {
                onSuccess: (response) => {
                    if (window.parent) {
                        window.parent.postMessage({ type: 'form-success', response: response }, '*');
                    }
                },
                onError: (response) => {
                    if (window.parent) {
                        window.parent.postMessage({ type: 'form-error', response: response }, '*');
                    }
                }
            });

            window.addEventListener('message', function(event) {
                if (event.data === 'submit-form') {
                    document.getElementById('form_validation').dispatchEvent(new Event('submit', { cancelable: true }));
                }
                if (event.data && event.data.type === 'reset-search') {
                    const form = document.getElementById('form_validation');
                    const resetInput = document.createElement('input');
                    resetInput.type = 'hidden';
                    resetInput.name = '_reset';
                    resetInput.value = '1';
                    form.appendChild(resetInput);
                    form.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });
        });
    </script>
{% endblock %}
